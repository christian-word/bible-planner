<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Читатель Библии</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .reader-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .navigation {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .book-list {
            margin-bottom: 20px;
        }
        
        .book-item {
            padding: 10px 15px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .book-item:hover {
            background: #e6edff;
            border-left-color: #667eea;
            transform: translateX(5px);
        }
        
        .book-item.active {
            background: #667eea;
            color: white;
            border-left-color: #4c51bf;
        }
        
        .chapter-selector {
            margin: 20px 0;
            display: none;
        }
        
        .chapter-selector.active {
            display: block;
        }
        
        .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
        }
        
        .verse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .chapter-btn, .verse-btn {
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .chapter-btn:hover, .verse-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .chapter-btn.active, .verse-btn.active {
            background: #667eea;
            color: white;
        }
        
        .reading-area {
            background: #fefefe;
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            min-height: 400px;
        }
        
        .chapter-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .chapter-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .verse {
            margin: 15px 0;
            line-height: 1.6;
            font-size: 16px;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .verse:hover {
            background: #f0f2ff;
        }
        
        .verse-number {
            font-weight: bold;
            color: #667eea;
            margin-right: 8px;
            font-size: 14px;
            vertical-align: super;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .search-box {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            width: 250px;
            transition: border-color 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .verse-selector {
            margin: 10px 0;
            display: none;
        }
        
        .verse-selector.active {
            display: block;
        }
        
        .bookmarks {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .bookmark-item {
            padding: 8px;
            margin: 5px 0;
            background: #fff5e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .bookmark-item:hover {
            background: #ffe4cc;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        @media (max-width: 768px) {
            .reader-container {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📖 Читатель Библии</h1>
        
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div id="readerContent">
            <div class="controls">
                <input type="text" class="search-box" id="searchBox" placeholder="🔍 Поиск по тексту..." />
                <button class="btn" onclick="clearBookmarks()">🗑️ Очистить закладки</button>
            </div>
            
            <div class="reader-container">
                <div class="navigation">
                    <h4>📚 Книги</h4>
                    <div id="bookList" class="book-list"></div>
                    
                    <div id="chapterSelector" class="chapter-selector">
                        <h4>📄 Главы</h4>
                        <div id="chapterGrid" class="chapter-grid"></div>
                    </div>
                    
                    <div id="verseSelector" class="verse-selector">
                        <h4>📝 Стихи</h4>
                        <div id="verseGrid" class="verse-grid"></div>
                    </div>
                    
                    <div class="bookmarks">
                        <h4>🔖 Закладки</h4>
                        <div id="bookmarksList"></div>
                    </div>
                </div>
                
                <div class="reading-area">
                    <div id="chapterContent">
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <h3>Загрузка Библии...</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let bibleData = null;
        let currentBook = null;
        let currentChapter = null;
        let bookmarks = JSON.parse(localStorage.getItem('bibleBookmarks') || '[]');
        
        // Загрузка Библии с GitHub
        document.addEventListener('DOMContentLoaded', function() {
            loadBibleFromGitHub();
        });
        
        function loadBibleFromGitHub() {
            showProgress();
            
            fetch('https://raw.githubusercontent.com/christian-word/bible-planner/main/json/bible.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка загрузки файла');
                    }
                    return response.json();
                })
                .then(data => {
                    bibleData = data;
                    setTimeout(() => {
                        initializeReader();
                        hideProgress();
                    }, 500);
                })
                .catch(error => {
                    hideProgress();
                    document.getElementById('chapterContent').innerHTML = `
                        <div class="error-section">
                            <h3>❌ Ошибка загрузки Библии</h3>
                            <p>${error.message}</p>
                            <p>Попробуйте обновить страницу или проверьте подключение к интернету.</p>
                        </div>
                    `;
                });
        }
        
        function showProgress() {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressFill.style.width = progress + '%';
                if (progress >= 90) {
                    clearInterval(interval);
                }
            }, 50);
        }
        
        function hideProgress() {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = '100%';
            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
                progressFill.style.width = '0%';
            }, 300);
        }
        
        // Инициализация читателя
        function initializeReader() {
            loadBookList();
            setupSearch();
            loadBookmarks();
        }
        
        function loadBookList() {
            const bookList = document.getElementById('bookList');
            bookList.innerHTML = '';
            
            bibleData.forEach((book, index) => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                bookItem.textContent = book.book;
                bookItem.onclick = () => selectBook(index);
                bookList.appendChild(bookItem);
            });
        }
        
        function selectBook(bookIndex) {
            currentBook = bookIndex;
            currentChapter = null;
            
            // Обновить выделение книги
            document.querySelectorAll('.book-item').forEach((item, index) => {
                item.classList.toggle('active', index === bookIndex);
            });
            
            // Показать главы
            loadChapterSelector();
            
            // Очистить содержимое
            document.getElementById('chapterContent').innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <h3>📄 Выберите главу для чтения</h3>
                    <p>Книга: ${bibleData[bookIndex].book}</p>
                </div>
            `;
            
            // Скрыть список стихов
            document.getElementById('verseSelector').classList.remove('active');
        }
        
        function loadChapterSelector() {
            const chapterSelector = document.getElementById('chapterSelector');
            const chapterGrid = document.getElementById('chapterGrid');
            
            chapterSelector.classList.add('active');
            chapterGrid.innerHTML = '';
            
            const book = bibleData[currentBook];
            book.chapters.forEach((chapter, index) => {
                const chapterBtn = document.createElement('div');
                chapterBtn.className = 'chapter-btn';
                chapterBtn.textContent = chapter.chapter || (index + 1);
                chapterBtn.onclick = () => selectChapter(index);
                chapterGrid.appendChild(chapterBtn);
            });
        }
        
        function selectChapter(chapterIndex) {
            currentChapter = chapterIndex;
            
            // Обновить выделение главы
            document.querySelectorAll('.chapter-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === chapterIndex);
            });
            
            // Показать селектор стихов
            document.getElementById('verseSelector').classList.add('active');
            loadVerseSelector();
            
            // Загрузить содержимое главы
            loadChapterContent();
        }
        
        function loadVerseSelector() {
            const verseGrid = document.getElementById('verseGrid');
            verseGrid.innerHTML = '';
            
            const chapter = bibleData[currentBook].chapters[currentChapter];
            chapter.verses.forEach(verse => {
                const verseBtn = document.createElement('div');
                verseBtn.className = 'verse-btn';
                verseBtn.textContent = verse.verse;
                verseBtn.onclick = () => {
                    // Удаляем выделение у всех стихов
                    document.querySelectorAll('.verse-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Добавляем выделение текущему стиху
                    verseBtn.classList.add('active');
                    // Прокручиваем к выбранному стиху
                    scrollToVerse(verse.verse);
                };
                verseGrid.appendChild(verseBtn);
            });
        }
        
        function scrollToVerse(verseNumber) {
            const verseElement = document.getElementById(`verse-${verseNumber}`);
            if (verseElement) {
                verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                verseElement.style.background = '#fff3cd';
                setTimeout(() => {
                    verseElement.style.background = '';
                }, 2000);
            }
        }
        
        function loadChapterContent() {
            const book = bibleData[currentBook];
            const chapter = book.chapters[currentChapter];
            const chapterContent = document.getElementById('chapterContent');
            
            let html = `
                <div class="chapter-header">
                    <div class="chapter-title">${book.book}</div>
                    <div style="color: #666;">Глава ${chapter.chapter || (currentChapter + 1)}</div>
                </div>
            `;
            
            chapter.verses.forEach(verse => {
                html += `
                    <div class="verse" id="verse-${verse.verse}">
                        <span class="verse-number">${verse.verse}</span>
                        ${verse.text}
                        <button style="float: right; background: none; border: none; cursor: pointer; opacity: 0.5;" 
                                onclick="addBookmark(${currentBook}, ${currentChapter}, ${verse.verse})" 
                                title="Добавить в закладки">🔖</button>
                    </div>
                `;
            });
            
            chapterContent.innerHTML = html;
        }
        
        function addBookmark(bookIndex, chapterIndex, verseNumber) {
            const bookmark = {
                book: bibleData[bookIndex].book,
                chapter: bibleData[bookIndex].chapters[chapterIndex].chapter || (chapterIndex + 1),
                verse: verseNumber,
                bookIndex,
                chapterIndex,
                text: bibleData[bookIndex].chapters[chapterIndex].verses.find(v => v.verse === verseNumber)?.text.substring(0, 50) + '...'
            };
            
            // Проверяем, нет ли уже такой закладки
            const exists = bookmarks.some(b => 
                b.bookIndex === bookmark.bookIndex && 
                b.chapterIndex === bookmark.chapterIndex && 
                b.verse === bookmark.verse
            );
            
            if (!exists) {
                bookmarks.push(bookmark);
                localStorage.setItem('bibleBookmarks', JSON.stringify(bookmarks));
                loadBookmarks();
                
                // Показываем уведомление о добавлении закладки
                alert(`Закладка добавлена: ${bookmark.book} ${bookmark.chapter}:${bookmark.verse}`);
            } else {
                alert('Эта закладка уже существует');
            }
        }
        
        function loadBookmarks() {
            const bookmarksList = document.getElementById('bookmarksList');
            bookmarksList.innerHTML = '';
            
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = '<p style="color: #666; font-size: 0.9em;">Нет сохраненных закладок</p>';
                return;
            }
            
            bookmarks.forEach((bookmark, index) => {
                const bookmarkItem = document.createElement('div');
                bookmarkItem.className = 'bookmark-item';
                bookmarkItem.innerHTML = `
                    <strong>${bookmark.book} ${bookmark.chapter}:${bookmark.verse}</strong><br>
                    <small>${bookmark.text}</small>
                    <button style="float: right; background: none; border: none; cursor: pointer; color: #ff6b6b;" 
                            onclick="event.stopPropagation(); removeBookmark(${index})" 
                            title="Удалить закладку">✕</button>
                `;
                bookmarkItem.onclick = () => {
                    selectBook(bookmark.bookIndex);
                    setTimeout(() => {
                        selectChapter(bookmark.chapterIndex);
                        setTimeout(() => {
                            scrollToVerse(bookmark.verse);
                            // Выделяем кнопку стиха в сетке
                            document.querySelectorAll('.verse-btn').forEach(btn => {
                                btn.classList.remove('active');
                                if (btn.textContent == bookmark.verse) {
                                    btn.classList.add('active');
                                }
                            });
                        }, 100);
                    }, 100);
                };
                bookmarksList.appendChild(bookmarkItem);
            });
        }
        
        function removeBookmark(index) {
            if (confirm('Удалить эту закладку?')) {
                bookmarks.splice(index, 1);
                localStorage.setItem('bibleBookmarks', JSON.stringify(bookmarks));
                loadBookmarks();
            }
        }
        
        function clearBookmarks() {
            if (confirm('Удалить все закладки?')) {
                bookmarks = [];
                localStorage.removeItem('bibleBookmarks');
                loadBookmarks();
            }
        }
        
        function setupSearch() {
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length < 3) {
                    // Убираем подсветку, если запрос слишком короткий
                    document.querySelectorAll('.verse').forEach(verse => {
                        verse.innerHTML = verse.innerHTML.replace(
                            /<span class="highlight">(.*?)<\/span>/gi,
                            '$1'
                        );
                    });
                    return;
                }
                
                // Простой поиск по текущей главе
                if (currentBook !== null && currentChapter !== null) {
                    const verses = document.querySelectorAll('.verse');
                    verses.forEach(verse => {
                        const text = verse.textContent.toLowerCase();
                        if (text.includes(query)) {
                            verse.innerHTML = verse.innerHTML.replace(
                                new RegExp(`(${query})`, 'gi'),
                                '<span class="highlight">$1</span>'
                            );
                        } else {
                            verse.innerHTML = verse.innerHTML.replace(
                                /<span class="highlight">(.*?)<\/span>/gi,
                                '$1'
                            );
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>