<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чтение Библии</title>
        <meta property="og:image" content="https://christian-word.github.io/bible-planner/ico/bible4.jpg" />
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #ffb366;
            --bg-color: #ffffff;
            --text-color: #333;
            --border-color: #e2e8f0;
            --hover-bg: #f0f2ff;
        }

        .dark-theme {
            --primary-color: #7c3aed;
            --secondary-color: #a855f7;
            --accent-color: #fbbf24;
            --bg-color: #1a1a1a;
            --text-color: #e5e7eb;
            --border-color: #374151;
            --hover-bg: #2d2d2d;
        }

        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Georgia', serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        body.dark-theme {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .container {
            background: var(--bg-color);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            margin: 2px;
        }
        
        .reader-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .navigation {
            background: var(--hover-bg);
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
            max-height: 70vh;
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }
        
        .book-item {
            padding: 12px 15px;
            margin: 5px 0;
            background: var(--bg-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .book-item:hover {
            background: var(--hover-bg);
            border-left-color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .book-item.active {
            background: var(--primary-color);
            color: white;
            border-left-color: var(--secondary-color);
            font-weight: 600;
        }
        
        .chapter-selector, .verse-selector {
            margin: 20px 0;
            display: none;
        }
        
        .chapter-selector.active, .verse-selector.active {
            display: block;
        }
        
        .chapter-grid, .verse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 8px;
        }
        
        .chapter-btn, .verse-btn {
            padding: 10px 8px;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .chapter-btn:hover, .verse-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .chapter-btn.active, .verse-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .reading-area {
            background: var(--bg-color);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            min-height: 400px;
            line-height: 1.7;
        }
        
        .chapter-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .chapter-title {
            font-size: 2.2em;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .verse {
            margin: 20px 0;
            line-height: 1.8;
            font-size: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            font-family: 'Georgia', 'Times New Roman', serif;
            color: var(--text-color);
        }
        
        .verse:hover {
            background: var(--hover-bg);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .verse-number {
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 12px;
            font-size: 16px;
            vertical-align: super;
            background: var(--hover-bg);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            min-width: 24px;
            text-align: center;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: var(--hover-bg);
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box, .reference-input {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            width: 300px;
            transition: all 0.3s ease;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .search-box:focus, .reference-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .quick-nav {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .verse-input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            width: 70px;
            text-align: center;
            margin-bottom: 10px;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .verse-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .bookmarks, .history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }
        
        .bookmark-item, .history-item {
            padding: 12px;
            margin: 8px 0;
            background: #fff5e6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            border-left: 3px solid var(--accent-color);
            color: #333;
        }

        .dark-theme .bookmark-item,
        .dark-theme .history-item {
            background: #2a2a2a;
            color: #e5e7eb;
        }
        
        .bookmark-item:hover, .history-item:hover {
            background: #ffe4cc;
            transform: translateX(3px);
        }

        .dark-theme .bookmark-item:hover,
        .dark-theme .history-item:hover {
            background: #3a3a3a;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .dark-theme .highlight {
            background: #fbbf24;
            color: #111;
        }
        
        .error {
            background: #fee;
            color: #c53030;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #c53030;
            margin: 20px 0;
        }

        .dark-theme .error {
            background: #2d1b1b;
            color: #fca5a5;
        }
        
        .section-header {
            margin: 15px 0 10px 0;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .verse-actions {
            float: right;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .verse:hover .verse-actions {
            opacity: 1;
        }

        .verse-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-left: 5px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .verse-actions button:hover {
            background: var(--hover-bg);
        }

         .note-indicator {
         color: var(--accent-color);
         font-weight: bold;
         font-size: 18px;
        }


        .global-search-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: var(--hover-bg);
        }

        .search-result-reference {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }



        /* Mobile styles */
        .mobile-mode .reader-container {
            grid-template-columns: 1fr;
        }
        
        .mobile-mode .navigation {
            max-height: 300px;
            position: static;
        }
        
        .mobile-mode .controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .mobile-mode .search-box,
        .mobile-mode .reference-input {
            width: 100%;
        }
        
        .mobile-mode .verse {
            font-size: 18px;
        }

        .mobile-mode .quick-nav {
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
            }
            
            .reader-container {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                max-height: 300px;
                position: static;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box,
            .reference-input {
                width: 100%;
            }
            
            .verse {
                font-size: 18px;
            }

            .quick-nav {
                justify-content: center;
            }

            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>📖 Чтение Библии</h1>
        
        <div id="loadingMessage" class="loading">
            <div class="loading-spinner"></div>
            <h3>Загружаем Библию...</h3>
            <p>Пожалуйста, подождите</p>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;">
            <h3>❌ Ошибка загрузки</h3>
            <p id="errorText"></p>
            <button class="btn" onclick="loadBible()">🔄 Попробовать снова</button>
        </div>
        
        <div id="readerContent" style="display: none;">
            <div class="controls">
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <input type="text" class="search-box" id="searchBox" placeholder="🔍 Поиск по тексту..." />
                    <button class="btn-secondary btn-small" onclick="performGlobalSearch()">Глобальный поиск</button>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <input type="text" class="reference-input" id="referenceInput" placeholder="Например: Матфей 5:9" />
                    <button class="btn-secondary btn-small" onclick="goToReference()">Перейти</button>
                </div>
                <div class="quick-nav">
                    <button class="btn-secondary btn-small" onclick="randomVerse()">🎲 Случайный стих</button>
                    <button class="btn-secondary btn-small" onclick="toggleTheme()">🌙 Тема</button>
                    <button class="btn-secondary btn-small" onclick="clearBookmarks()">🗑️ Очистить закладки</button>
                    <button class="btn-secondary btn-small" onclick="loadLastRead()">📍 Последнее место</button>
                    <button class="btn-secondary btn-small" onclick="loadNotesList()">📝 Все заметки</button>
                </div>
            </div>
            
            <div class="reader-container">
                <div class="navigation">
                    <div class="section-header">📚 Книги</div>
                    <div id="bookList" class="book-list"></div>
                    
                    <div id="chapterSelector" class="chapter-selector">
                        <div class="section-header">📄 Главы</div>
                        <div id="chapterGrid" class="chapter-grid"></div>
                    </div>
                    
                    <div id="verseSelector" class="verse-selector">
                        <div class="section-header">📝 Стихи</div>
                        <input type="number" class="verse-input" id="verseInput" min="1" placeholder="№ стиха" />
                        <button class="btn-secondary btn-small" onclick="goToVerse()">Перейти</button>
                        <div id="verseGrid" class="verse-grid"></div>
                    </div>
                    
                    <div class="bookmarks">
                        <div class="section-header">🔖 Закладки</div>
                        <div id="bookmarksList"></div>
                    </div>

                    <div class="history">
                        <div class="section-header">🕓 История</div>
                        <div id="historyList"></div>
                    </div>

                    <div class="notes">
                      <div class="section-header">📝 Заметки</div>
                      <div id="notesList"></div>
                    </div>
                </div>
                
                <div class="reading-area">
                    <div id="chapterContent">
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <h3>👈 Выберите книгу и главу для чтения</h3>
                            <p>Используйте навигацию слева для выбора нужной книги и главы</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<footer style="
    margin-top: 60px;
    padding: 20px;
    text-align: center;
    font-size: 15px;
    color: white;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
">
    Церква ЄХБ “Дім Євангелія”, м. Суми, Україна · Версія збірки 1.0 · © 2025 р.
</footer>
<script>
    let bibleData = null;
    let currentBook = null;
    let currentChapter = null;
    let bookmarks = [];
    let history = [];
    let notes = {};

    // Загрузка сохраненных данных
    try {
        const savedBookmarks = localStorage.getItem('bibleBookmarks');
        if (savedBookmarks) bookmarks = JSON.parse(savedBookmarks);
        
        const savedHistory = localStorage.getItem('bibleHistory');
        if (savedHistory) history = JSON.parse(savedHistory);
        
        const savedNotes = localStorage.getItem('bibleNotes');
        if (savedNotes) notes = JSON.parse(savedNotes);
    } catch (e) {
        console.warn('Ошибка загрузки сохраненных данных:', e);
    }

    window.addEventListener('load', async () => {
        detectMobileMode();
        loadSavedTheme();
        await loadBible();
    });

    window.addEventListener('resize', detectMobileMode);

async function fetchBibleWithCache() {
    const response = await fetch('https://raw.githubusercontent.com/christian-word/bible-planner/refs/heads/main/json/bible.json');
    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    return await response.json();
}


    async function loadBible() {
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const readerContent = document.getElementById('readerContent');

        loadingMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        readerContent.style.display = 'none';

        try {
            const originalData = await fetchBibleWithCache();

            const oldTestament = originalData.slice(0, 39);
            const newTestament = originalData.slice(39);

            bibleData = [
                { title: "📜 Ветхий Завет", isSection: true },
                ...oldTestament,
                { title: "✝️ Новый Завет", isSection: true },
                ...newTestament
            ];

            loadingMessage.style.display = 'none';
            readerContent.style.display = 'block';

            initializeReader();

        } catch (error) {
            console.error('Ошибка загрузки Библии:', error);
            loadingMessage.style.display = 'none';
            errorMessage.style.display = 'block';
            document.getElementById('errorText').textContent = `Не удалось загрузить Библию: ${error.message}`;
        }
    }

    function initializeReader() {
        loadBookList();
        setupSearch();
        loadBookmarks();
        loadHistoryList();
        loadNotesList(); // ← добавить сюда
    }

    // Обновление заголовка страницы
    function updatePageTitle(book, chapter) {
        document.title = book && chapter ? `📚 ${book} ${chapter} | Библия` : "Чтение Библии";
    }

    // Автоопределение мобильного режима
    function detectMobileMode() {
        const isMobile = window.innerWidth < 768;
        document.body.classList.toggle('mobile-mode', isMobile);
    }

    // Переключение темы
    function applyTheme(mode) {
        document.body.classList.toggle('dark-theme', mode === 'dark');
        localStorage.setItem('theme', mode);
    }

    function toggleTheme() {
        const current = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
        applyTheme(current);
    }

    function loadSavedTheme() {
        const theme = localStorage.getItem('theme') || 'light';
        applyTheme(theme);
    }

    // История просмотров
    function addToHistory(bookIndex, chapterIndex) {
        const book = bibleData[bookIndex];
        if (!book || book.isSection) return;
        
        const entry = {
            book: book.book,
            chapter: book.chapters[chapterIndex].chapter || (chapterIndex + 1),
            bookIndex,
            chapterIndex,
            timestamp: Date.now()
        };
        
        // Удаляем дубликат если есть
        history = history.filter(h => !(h.bookIndex === bookIndex && h.chapterIndex === chapterIndex));
        history.unshift(entry);
        
        // Ограничиваем историю 10 записями
        if (history.length > 10) history.length = 10;
        
        try {
            localStorage.setItem('bibleHistory', JSON.stringify(history));
        } catch (e) {
            console.warn('Ошибка сохранения истории:', e);
        }
        
        loadHistoryList();
    }

    function loadHistoryList() {
        const historyList = document.getElementById('historyList');
        if (!historyList) return;

        historyList.innerHTML = '';

        if (history.length === 0) {
            historyList.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center;">Нет истории</p>';
            return;
        }

        history.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'history-item';
            itemDiv.innerHTML = `<strong>${item.book} ${item.chapter}</strong>`;
            itemDiv.onclick = () => {
                selectBook(item.bookIndex);
                setTimeout(() => selectChapter(item.chapterIndex), 200);
            };
            historyList.appendChild(itemDiv);
        });
    }

    // Автосохранение последнего места
    function saveLastRead(bookIndex, chapterIndex) {
        try {
            localStorage.setItem('lastRead', JSON.stringify({ bookIndex, chapterIndex }));
        } catch (e) {
            console.warn('Ошибка сохранения последнего места:', e);
        }
    }

    function loadLastRead() {
        try {
            const data = JSON.parse(localStorage.getItem('lastRead') || 'null');
            if (data && bibleData && bibleData[data.bookIndex] && !bibleData[data.bookIndex].isSection) {
                selectBook(data.bookIndex);
                setTimeout(() => selectChapter(data.chapterIndex), 200);
            }
        } catch (e) {
            console.warn('Ошибка загрузки последнего места:', e);
        }
    }

    // Заметки
    function addNote(bookIndex, chapterIndex, verseNumber, text) {
        const key = `${bookIndex}:${chapterIndex}:${verseNumber}`;
        if (text && text.trim()) {
            notes[key] = text.trim();
        } else {
            delete notes[key];
        }
        try {
            localStorage.setItem('bibleNotes', JSON.stringify(notes));
        } catch (e) {
            console.warn('Ошибка сохранения заметки:', e);
        }
    }

    function getNote(bookIndex, chapterIndex, verseNumber) {
        const key = `${bookIndex}:${chapterIndex}:${verseNumber}`;
        return notes[key] || '';
    }

    function showNoteDialog(bookIndex, chapterIndex, verseNumber) {
        const current = getNote(bookIndex, chapterIndex, verseNumber);
        const text = prompt("Введите заметку для стиха:", current);
        if (text !== null) {
            addNote(bookIndex, chapterIndex, verseNumber, text);
            loadChapterContent(); // Перезагружаем содержимое для обновления индикаторов
        }
    }

    // Быстрый переход по ссылке
    function parseReference(input) {
        const trimmed = input.trim();
        const match = trimmed.match(/^(.+?)\s+(\d+)(?::(\d+))?$/);
        if (!match) return false;

        const [, bookName, chapterNum, verseNum] = match;
        const bookIndex = bibleData.findIndex(b => 
            b.book && b.book.toLowerCase().includes(bookName.toLowerCase().trim())
        );

        if (bookIndex >= 0 && !bibleData[bookIndex].isSection) {
            const chapterIndex = parseInt(chapterNum) - 1;
            if (chapterIndex >= 0 && chapterIndex < bibleData[bookIndex].chapters.length) {
                selectBook(bookIndex);
                setTimeout(() => {
                    selectChapter(chapterIndex);
                    if (verseNum) {
                        setTimeout(() => selectVerse(parseInt(verseNum)), 300);
                    }
                }, 200);
                return true;
            }
        }
        return false;
    }

    function goToReference() {
        const input = document.getElementById('referenceInput');
        if (!input || !input.value.trim()) return;

        if (!parseReference(input.value)) {
            alert('Неверный формат ссылки. Используйте формат: "Название главы стих" (например: "Матфей 5:9")');
        } else {
            input.value = '';
        }
    }

    // Глобальный поиск
    function globalSearch(query) {
        if (!query || query.length < 2) return [];
        
        const results = [];
        const searchQuery = query.toLowerCase();
        
        bibleData.forEach((book, bookIndex) => {
            if (book.isSection) return;
            
            book.chapters.forEach((chapter, chapterIndex) => {
                chapter.verses.forEach(verse => {
                    if (verse.text && verse.text.toLowerCase().includes(searchQuery)) {
                        results.push({
                            book: book.book,
                            chapter: chapter.chapter || (chapterIndex + 1),
                            verse: verse.verse,
                            text: verse.text,
                            bookIndex,
                            chapterIndex
                        });
                    }
                });
            });
        });
        
        return results.slice(0, 100); // Ограничиваем результаты
    }

    function performGlobalSearch() {
        const searchBox = document.getElementById('searchBox');
        if (!searchBox || !searchBox.value.trim()) return;

        const query = searchBox.value.trim();
        const results = globalSearch(query);
        renderGlobalSearchResults(results, query);
    }

    function renderGlobalSearchResults(results, query) {
        const chapterContent = document.getElementById('chapterContent');
        if (!chapterContent) return;

        if (results.length === 0) {
            chapterContent.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <h3>🔍 Поиск: "${query}"</h3>
                    <p>Ничего не найдено</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="chapter-header">
                <div class="chapter-title">🔍 Результаты поиска</div>
                <div style="color: #666; font-size: 1.2em;">Запрос: "${query}" (найдено: ${results.length})</div>
            </div>
            <div class="global-search-results">
        `;

        results.forEach(result => {
            const highlightedText = result.text.replace(
                new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'),
                '<span class="highlight">$1</span>'
            );
            
            html += `
                <div class="search-result-item" onclick="goToSearchResult(${result.bookIndex}, ${result.chapterIndex}, ${result.verse})">
                    <div class="search-result-reference">${result.book} ${result.chapter}:${result.verse}</div>
                    <div>${highlightedText}</div>
                </div>
            `;
        });

        html += '</div>';
        chapterContent.innerHTML = html;
    }

    function goToSearchResult(bookIndex, chapterIndex, verseNumber) {
        selectBook(bookIndex);
        setTimeout(() => {
            selectChapter(chapterIndex);
            setTimeout(() => selectVerse(verseNumber), 300);
        }, 200);
    }

    function loadBookList() {
        const bookList = document.getElementById('bookList');
        if (!bookList) return;

        bookList.innerHTML = '';

        bibleData.forEach((book, index) => {
            const bookItem = document.createElement('div');

            if (book.isSection) {
                bookItem.textContent = book.title;
                bookItem.style.fontWeight = 'bold';
                bookItem.style.marginTop = '20px';
                bookItem.style.color = 'var(--text-color)';
                bookItem.style.padding = '8px 0';
            } else {
                bookItem.className = 'book-item';
                bookItem.textContent = book.book || `Книга ${index + 1}`;
                bookItem.onclick = () => selectBook(index);
            }

            bookList.appendChild(bookItem);
        });
    }

    function selectBook(bookIndex) {
        const selected = bibleData[bookIndex];
        if (!selected || selected.isSection) return;

        currentBook = bookIndex;
        currentChapter = null;

        document.querySelectorAll('.book-item').forEach((item, index) => {
            const actualIndex = bibleData.findIndex((book, i) => i === index && !book.isSection);
            item.classList.toggle('active', index === bookIndex);
        });

        loadChapterSelector();

        const verseSelector = document.getElementById('verseSelector');
        if (verseSelector) verseSelector.classList.remove('active');

        const chapterContent = document.getElementById('chapterContent');
        if (chapterContent) {
            chapterContent.innerHTML = `
                <div style="text-align: center; padding: 50px; color: var(--text-color); opacity: 0.7;">
                    <h3>📄 Выберите главу для чтения</h3>
                    <p>Книга: <strong>${bibleData[bookIndex].book}</strong></p>
                    <p>Доступно глав: ${bibleData[bookIndex].chapters.length}</p>
                </div>
            `;
        }

        updatePageTitle(bibleData[bookIndex].book, null);
    }

    function loadChapterSelector() {
        const chapterSelector = document.getElementById('chapterSelector');
        const chapterGrid = document.getElementById('chapterGrid');
        if (!chapterSelector || !chapterGrid) return;

        chapterSelector.classList.add('active');
        chapterGrid.innerHTML = '';

        const book = bibleData[currentBook];
        book.chapters.forEach((chapter, index) => {
            const chapterBtn = document.createElement('div');
            chapterBtn.className = 'chapter-btn';
            chapterBtn.textContent = chapter.chapter || (index + 1);
            chapterBtn.onclick = () => selectChapter(index);
            chapterGrid.appendChild(chapterBtn);
        });
    }

    function selectChapter(chapterIndex) {
        if (currentBook === null || chapterIndex < 0 || chapterIndex >= bibleData[currentBook].chapters.length) return;

        currentChapter = chapterIndex;

        document.querySelectorAll('.chapter-btn').forEach((btn, index) => {
            btn.classList.toggle('active', index === chapterIndex);
        });

        const verseSelector = document.getElementById('verseSelector');
        if (verseSelector) verseSelector.classList.add('active');

        const verseInput = document.getElementById('verseInput');
        if (verseInput) {
            const maxVerses = bibleData[currentBook].chapters[chapterIndex].verses.length;
            verseInput.max = maxVerses;
        }

        loadVerseGrid();
        loadChapterContent();
        addToHistory(currentBook, currentChapter);
        saveLastRead(currentBook, currentChapter);

        const book = bibleData[currentBook];
        const chapter = book.chapters[currentChapter];
        updatePageTitle(book.book, chapter.chapter || (currentChapter + 1));
    }

    function loadVerseGrid() {
        const verseGrid = document.getElementById('verseGrid');
        if (!verseGrid) return;

        verseGrid.innerHTML = '';

        const chapter = bibleData[currentBook].chapters[currentChapter];
        chapter.verses.forEach(verse => {
            const verseBtn = document.createElement('div');
            verseBtn.className = 'verse-btn';
            verseBtn.textContent = verse.verse;
            verseBtn.onclick = () => selectVerse(verse.verse);
            verseGrid.appendChild(verseBtn);
        });
    }

    function selectVerse(verseNumber) {
        document.querySelectorAll('.verse-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.textContent) === verseNumber);
        });

        const verseInput = document.getElementById('verseInput');
        if (verseInput) verseInput.value = verseNumber;

        goToVerse();
    }

    function loadChapterContent() {
        if (currentBook === null || currentChapter === null) return;

        const book = bibleData[currentBook];
        const chapter = book.chapters[currentChapter];
        const chapterContent = document.getElementById('chapterContent');
        if (!chapterContent) return;

        let html = `
            <div class="chapter-header">
                <div class="chapter-title">${book.book}</div>
                <div style="color: #666; font-size: 1.2em;">Глава ${chapter.chapter || (currentChapter + 1)}</div>
            </div>
        `;

        chapter.verses.forEach(verse => {
            const verseText = verse.text || '';
            const hasNote = getNote(currentBook, currentChapter, verse.verse);
            
            html += `
                <div class="verse" id="verse-${verse.verse}">
                    <span class="verse-number">${verse.verse}</span>
                    ${verseText}
                    <div class="verse-actions">
                        <button onclick="addBookmark(${currentBook}, ${currentChapter}, ${verse.verse})" 
                                title="Добавить в закладки">🔖</button>
<button 
    onclick="showNoteDialog(${currentBook}, ${currentChapter}, ${verse.verse})" 
    title="${hasNote ? getNote(currentBook, currentChapter, verse.verse).replace(/"/g, '&quot;') : 'Заметка'}"
    ${hasNote ? 'class="note-indicator"' : ''}>📝</button>

                    </div>
                </div>
            `;
        });

        chapterContent.innerHTML = html;
    }

    function goToVerse() {
        const verseInput = document.getElementById('verseInput');
        if (!verseInput) return;

        const verseNumber = parseInt(verseInput.value);
        if (isNaN(verseNumber) || verseNumber < 1 || currentBook === null || currentChapter === null) return;

        document.querySelectorAll('.verse-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.textContent) === verseNumber);
        });

        const verseElement = document.getElementById(`verse-${verseNumber}`);
        if (verseElement) {
            verseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            verseElement.style.background = 'var(--hover-bg)';
            verseElement.style.border = '2px solid var(--primary-color)';
            setTimeout(() => {
                verseElement.style.background = '';
                verseElement.style.border = '';
            }, 3000);
        }
    }

    function randomVerse() {
        const onlyBooks = bibleData.filter(b => !b.isSection);
        const randomBookIndex = Math.floor(Math.random() * onlyBooks.length);
        const book = onlyBooks[randomBookIndex];
        const globalIndex = bibleData.indexOf(book);

        const randomChapter = Math.floor(Math.random() * book.chapters.length);
        const randomVerseIndex = Math.floor(Math.random() * book.chapters[randomChapter].verses.length);

        selectBook(globalIndex);
        setTimeout(() => {
            selectChapter(randomChapter);
            setTimeout(() => {
                const verse = book.chapters[randomChapter].verses[randomVerseIndex];
                selectVerse(verse.verse);
            }, 300);
        }, 200);
    }

    function addBookmark(bookIndex, chapterIndex, verseNumber) {
        const book = bibleData[bookIndex];
        if (!book || book.isSection) return;

        const verseData = book.chapters[chapterIndex].verses.find(v => v.verse === verseNumber);
        if (!verseData) return;

        const bookmark = {
            book: book.book,
            chapter: book.chapters[chapterIndex].chapter || (chapterIndex + 1),
            verse: verseNumber,
            bookIndex,
            chapterIndex,
            text: (verseData.text || '').substring(0, 50) + (verseData.text && verseData.text.length > 50 ? '...' : ''),
            timestamp: Date.now()
        };

        const exists = bookmarks.some(b =>
            b.bookIndex === bookIndex &&
            b.chapterIndex === chapterIndex &&
            b.verse === verseNumber
        );

        if (!exists) {
            bookmarks.push(bookmark);
            try {
                localStorage.setItem('bibleBookmarks', JSON.stringify(bookmarks));
            } catch (e) {
                console.warn('Не удалось сохранить закладки:', e);
            }
            loadBookmarks();
            
            // Показать уведомление
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '✅';
            button.style.color = 'green';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.color = '';
            }, 1000);
        }
    }

    function loadBookmarks() {
        const bookmarksList = document.getElementById('bookmarksList');
        if (!bookmarksList) return;

        bookmarksList.innerHTML = '';

        if (bookmarks.length === 0) {
            bookmarksList.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center;">Нет закладок</p>';
            return;
        }

        bookmarks.forEach((bookmark, index) => {
            const bookmarkItem = document.createElement('div');
            bookmarkItem.className = 'bookmark-item';
            bookmarkItem.innerHTML = `
                <strong>${bookmark.book} ${bookmark.chapter}:${bookmark.verse}</strong><br>
                <small>${bookmark.text}</small>
                <button style="float: right; background: none; border: none; color: #999; cursor: pointer;" 
                        onclick="removeBookmark(${index})" title="Удалить закладку">×</button>
            `;
            bookmarkItem.onclick = (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    selectBook(bookmark.bookIndex);
                    setTimeout(() => {
                        selectChapter(bookmark.chapterIndex);
                        setTimeout(() => {
                            selectVerse(bookmark.verse);
                        }, 300);
                    }, 200);
                }
            };
            bookmarksList.appendChild(bookmarkItem);
        });
    }

function loadNotesList() {
    const notesList = document.getElementById('notesList');
    if (!notesList) return;

    notesList.innerHTML = '';

    const keys = Object.keys(notes);
    if (keys.length === 0) {
        notesList.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center;">Нет заметок</p>';
        return;
    }

    keys.forEach(key => {
        const [bookIndex, chapterIndex, verseNumber] = key.split(':').map(Number);
        const noteText = notes[key];
        const book = bibleData[bookIndex];
        if (!book || book.isSection) return;

        const noteItem = document.createElement('div');
        noteItem.className = 'bookmark-item';
        noteItem.innerHTML = `<strong>${book.book} ${chapterIndex + 1}:${verseNumber}</strong><br>
            <small>${noteText}</small>`;
        noteItem.onclick = () => {
            selectBook(bookIndex);
            setTimeout(() => {
                selectChapter(chapterIndex);
                setTimeout(() => {
                    selectVerse(verseNumber);
                }, 300);
            }, 200);
        };
        notesList.appendChild(noteItem);
    });
}

    function removeBookmark(index) {
        bookmarks.splice(index, 1);
        try {
            localStorage.setItem('bibleBookmarks', JSON.stringify(bookmarks));
        } catch (e) {
            console.warn('Ошибка удаления закладки:', e);
        }
        loadBookmarks();
    }

    function clearBookmarks() {
        if (confirm('Удалить все закладки?')) {
            bookmarks = [];
            try {
                localStorage.removeItem('bibleBookmarks');
            } catch (e) {
                console.warn('Ошибка при удалении закладок:', e);
            }
            loadBookmarks();
        }
    }

    function setupSearch() {
        const searchBox = document.getElementById('searchBox');
        if (!searchBox) return;

        searchBox.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (query.length < 2) {
                if (currentBook !== null && currentChapter !== null) {
                    const verses = document.querySelectorAll('.verse');
                    verses.forEach(verse => {
                        const html = verse.innerHTML.replace(/<span class="highlight">(.*?)<\/span>/gi, '$1');
                        verse.innerHTML = html;
                    });
                }
                return;
            }

            if (currentBook !== null && currentChapter !== null) {
                const verses = document.querySelectorAll('.verse');
                verses.forEach(verse => {
                    let html = verse.innerHTML.replace(/<span class="highlight">(.*?)<\/span>/gi, '$1');
                    const text = verse.textContent.toLowerCase();
                    if (text.includes(query)) {
                        try {
                            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                            html = html.replace(regex, '<span class="highlight">$1</span>');
                        } catch (e) {
                            console.warn('Ошибка в регулярном выражении:', e);
                        }
                    }
                    verse.innerHTML = html;
                });
            }
        });

        // Обработка Enter для быстрого перехода по ссылке
        const referenceInput = document.getElementById('referenceInput');
        if (referenceInput) {
            referenceInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    goToReference();
                }
            });
        }

        // Обработка Enter для глобального поиска
        searchBox.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performGlobalSearch();
            }
        });
    }

    // Инициализация после загрузки
    document.addEventListener('DOMContentLoaded', () => {
        // Дополнительная инициализация если нужна
    });

    </script>
</body>
</html>










